@page "/kitsu"
@using AnySync.Brazor.Services
@inject KitsuService service

@using anisync.Models.Kitsu.StructuredModels

<MudTextField @bind-Value="@kitsuUsername" Label="Kitsu Username" Variant="Variant.Outlined"
@oninput="UpdateKitsuUserName" Error="@_kitsuUsernameHasError"></MudTextField>
@if (_kitsuUsernameHasError)
{
    <MudAlert Severity="Severity.Error" Dense="true" Class="my-2">Kitsu Username is necessary.</MudAlert>
}
<MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="GetLibraryEntriesReponse">Carregar Biblioteca
</MudButton>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
    <MudTabPanel Text="Anime">
        <MudTable Items="@animeEntries" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
            LoadingProgressColor="Color.Info">
            <HeaderContent>
                <MudTh>Thumb</MudTh>
                <MudTh>Canonical Title</MudTh>
                <MudTh>Kitsu Link</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Thumb">
                    <MudImage Src="@context.AnimeAttribute.posterImage.small" Width="64" Height="64" Alt="Mony the dog"
                        Elevation="25" Class="rounded-lg" />
                </MudTd>
                <MudTd DataLabel="Canonical Title">@context.AnimeAttribute.canonicalTitle</MudTd>
                <MudTd DataLabel="Kitsu Link">@context.AnimeAttribute.canonicalTitle</MudTd>
            </RowTemplate>
        </MudTable>
    </MudTabPanel>
    <MudTabPanel Text="Manga">
        <MudTable Items="@mangaEntries" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
            LoadingProgressColor="Color.Info">
            <HeaderContent>
                <MudTh>Thumb</MudTh>
                <MudTh>Canonical Title</MudTh>
                <MudTh>Kitsu Link</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Thumb">
                    <MudImage Src="@context.MangaAttribute.posterImage.small" Width="64" Height="64" Alt="Mony the dog"
                        Elevation="25" Class="rounded-lg" />
                </MudTd>
                <MudTd DataLabel="Canonical Title">@context.MangaAttribute.canonicalTitle</MudTd>
                <MudTd DataLabel="Kitsu Link">@context.MangaAttribute.canonicalTitle</MudTd>
            </RowTemplate>
        </MudTable>
    </MudTabPanel>
</MudTabs>

@code {

    public List<AnimeEntryDto>? animeEntries = new List<AnimeEntryDto>();
    public List<MangaEntryDto>? mangaEntries = new List<MangaEntryDto>();


    private bool _loading;
    private string? kitsuUsername;
    private bool _kitsuUsernameHasError = false;

    private void UpdateKitsuUserName(ChangeEventArgs e)
    {
        kitsuUsername = e.Value.ToString();
    }

    public async Task GetLibraryEntriesReponse()
    {
        if (string.IsNullOrEmpty(kitsuUsername))
        {
            _kitsuUsernameHasError = true;
            return;
        }

        _loading = true;
        var kitsuEntries = await service.GetEntries(kitsuUsername);
        animeEntries = kitsuEntries.animes;
        mangaEntries = kitsuEntries.mangas;
        _loading = false;
    }
}
